<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Sheet</title>
  <link rel="icon" href="images/school-logo.png">
  <link rel="stylesheet" href="attendance.css">
</head>

<body>

  <header>
    <img src="images/school-logo.png" alt="School Logo" class="profile-pic" />
    <nav class="header-nav">
      <a href="index.html#home">Home</a>
      <a href="index.html#about">About</a>
      <a href="index.html#services">Services</a>
      <a href="index.html#contact">Contact</a>
    </nav>
  </header>

  <main>
    <div class="container">
      <h1>Attendance Sheet</h1>

      <div class="input-container">
        <input type="text" id="studentName" placeholder="Enter student name" />
        <button id="addBtn">Add Student</button>
      </div>

      <table id="attendanceTable">
        <thead>
          <tr>
            <th>Time Added</th>
            <th>Student Name</th>
            <th>Picture</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
    const addBtn = document.getElementById("addBtn");
    const studentNameInput = document.getElementById("studentName");
    const attendanceTable = document.querySelector("#attendanceTable tbody");

    let sectionData = JSON.parse(localStorage.getItem("sectionData")) || {
      creator: localStorage.getItem("userEmail"),
      students: []
    };

    function saveSectionData() {
      localStorage.setItem("sectionData", JSON.stringify(sectionData));
    }

    function checkIsTeacher() {
      const email = localStorage.getItem("userEmail");
      const role = localStorage.getItem("role");
      return role === "teacher" && email === sectionData.creator;
    }

    function addStudentRow(student) {
      const { name, image, status, addedTime } = student;

      const row = document.createElement("tr");

      const timeCell = document.createElement("td");
      timeCell.textContent = addedTime;

      const nameCell = document.createElement("td");
      nameCell.textContent = name;

      const pictureCell = document.createElement("td");
      const uploadBtn = document.createElement("button");
      uploadBtn.textContent = "Upload";
      uploadBtn.classList.add("upload-btn");

      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.style.display = "none";

      const imagePreview = document.createElement("img");
      imagePreview.classList.add("upload-img");
      if (image) {
        imagePreview.src = image;
        imagePreview.style.display = "block";
        uploadBtn.style.display = "none";
      }

      uploadBtn.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          imagePreview.src = e.target.result;
          imagePreview.style.display = "block";
          uploadBtn.style.display = "none";
          const idx = sectionData.students.findIndex(s => s.name === name);
          sectionData.students[idx].image = e.target.result;
          saveSectionData();
        };
        reader.readAsDataURL(file);
      });

      pictureCell.append(uploadBtn, fileInput, imagePreview);

      const statusCell = document.createElement("td");
      const presentBtn = document.createElement("button");
      presentBtn.textContent = "Present";
      presentBtn.classList.add("status-btn", "present");

      const absentBtn = document.createElement("button");
      absentBtn.textContent = "Absent";
      absentBtn.classList.add("status-btn", "absent");

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "âœ–";
      deleteBtn.classList.add("delete-btn");

      const statusCircle = document.createElement("div");
      statusCircle.classList.add("status-circle");
      if (status === "Present") statusCircle.style.background = "green";
      if (status === "Absent") statusCircle.style.background = "red";

      if (checkIsTeacher()) {
        presentBtn.addEventListener("click", () => {
          statusCircle.style.background = "green";
          updateStatus("Present");
        });
        absentBtn.addEventListener("click", () => {
          statusCircle.style.background = "red";
          updateStatus("Absent");
        });
        deleteBtn.addEventListener("click", () => {
          if (confirm(`Delete student "${name}"?`)) {
            row.remove();
            sectionData.students = sectionData.students.filter(s => s.name !== name);
            saveSectionData();
          }
        });
      } else {
        presentBtn.disabled = true;
        absentBtn.disabled = true;
        presentBtn.style.opacity = 0.5;
        absentBtn.style.opacity = 0.5;
        deleteBtn.style.display = "none";
      }

      function updateStatus(newStatus) {
        const idx = sectionData.students.findIndex(s => s.name === name);
        sectionData.students[idx].status = newStatus;
        saveSectionData();
      }
      statusCell.classList.add("status-cell");
      statusCell.append(presentBtn, absentBtn, statusCircle, deleteBtn);
      row.append(timeCell, nameCell, pictureCell, statusCell);
      attendanceTable.appendChild(row);
    }

    sectionData.students.forEach(s => addStudentRow(s));

    addBtn.addEventListener("click", () => {
      const name = studentNameInput.value.trim();
      if (!name) return alert("Enter student name.");
      if (sectionData.students.some(s => s.name === name)) {
        return alert("Student already exists.");
      }
      const newStudent = {
        name,
        image: null,
        status: "",
        addedTime: new Date().toLocaleTimeString()
      };
      sectionData.students.push(newStudent);
      saveSectionData();
      addStudentRow(newStudent);
      studentNameInput.value = "";
    });
  </script>

</body>

</html>