<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Sheet</title>
  <link rel="icon" href="images/school-logo.png">
  <link rel="stylesheet" href="attendance.css">
</head>

<body>

  <header>
    <img src="images/school-logo.png" alt="School Logo" class="profile-pic" />
    <nav class="header-nav">
      <a href="index.html#home">Home</a>
      <a href="index.html#about">About</a>
      <a href="index.html#services">Services</a>
      <a href="index.html#contact">Contact</a>
      <div class="user-icon-container">
        <img src="images/1.png" alt="User Icon" id="userIcon" style="width: 45px; height: 45px; border-radius: 50%; cursor: pointer;">
        <div id="authPopup" class="auth-popup" style="position: absolute; top: 55px; right: 0; background: #101827; padding: 10px; border-radius: 10px; display: none; flex-direction: column; gap: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); z-index: 1000;">
          <button id="loginBtn" style="padding: 8px 12px; border: none; border-radius: 6px; background: #6ee7b7; color: black; font-weight: bold; cursor: pointer;">Login</button>
          <button id="registerBtn" style="padding: 8px 12px; border: none; border-radius: 6px; background: #6ee7b7; color: black; font-weight: bold; cursor: pointer;">Create Account</button>
          <button id="logoutBtn" style="display: none; padding: 8px 12px; border: none; border-radius: 6px; background: #6ee7b7; color: black; font-weight: bold; cursor: pointer;">Logout</button>
        </div>
      </div>
    </nav>
  </header>

  <main>
    <div class="container">
      <h1>Attendance Sheet</h1>

      <div class="input-container">
        <input type="text" id="studentName" placeholder="Enter student name" />
        <button id="addBtn">Add Student</button>
      </div>

      <table id="attendanceTable">
        <thead>
          <tr>
            <th>Time Added</th>
            <th>Student Name</th>
            <th>Picture</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <div id="imageModal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9);" onclick="this.style.display='none'">
    <span style="position:absolute; top:20px; right:40px; color:#fff; font-size:40px; font-weight:bold; cursor:pointer;">&times;</span>
    <img id="modalImage" style="margin:auto; display:block; max-width:90%; max-height:90%; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);" onclick="event.stopPropagation()">
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const userIcon = document.getElementById('userIcon');
      const authPopup = document.getElementById('authPopup');
      const loginBtn = document.getElementById('loginBtn');
      const registerBtn = document.getElementById('registerBtn');
      const logoutBtn = document.getElementById('logoutBtn');

      userIcon.addEventListener('click', e => {
        e.stopPropagation();
        authPopup.style.display = authPopup.style.display === 'flex' ? 'none' : 'flex';
      });
      window.addEventListener('click', () => authPopup.style.display = 'none');

      loginBtn.onclick = () => window.location.href = 'user.html';
      registerBtn.onclick = () => window.location.href = 'user.html';
      logoutBtn.onclick = async () => {
        try { await fetch('api/logout.php', { method: 'POST', credentials: 'include' }); } catch (e) { }
        sessionStorage.clear();
        window.location.reload();
      };

      function updateLoginStatus() {
        const isLoggedIn = sessionStorage.getItem('loggedIn') === 'true';
        loginBtn.style.display = isLoggedIn ? 'none' : 'block';
        registerBtn.style.display = isLoggedIn ? 'none' : 'block';
        logoutBtn.style.display = isLoggedIn ? 'block' : 'none';
      }
      updateLoginStatus();

      const addBtn = document.getElementById("addBtn");
      const studentNameInput = document.getElementById("studentName");
      const attendanceTable = document.querySelector("#attendanceTable tbody");

      const userEmail = sessionStorage.getItem('userEmail');
      const userRole = sessionStorage.getItem('role');
      const userName = sessionStorage.getItem('name');

      const urlParams = new URLSearchParams(window.location.search);
      const sectionName = urlParams.get('section');
      const owner = urlParams.get('owner');

      const isOwnerTeacher = userRole === 'teacher' && userEmail === owner;

      if (isOwnerTeacher) {
        addBtn.textContent = "Add Student";
      } else if (userRole === 'student') {
        addBtn.textContent = "Add Myself";
        studentNameInput.value = userName; 
      } else {
        addBtn.style.display = 'none';
      }

      async function loadStudents() {
        try {
          const res = await fetch(`api/students.php?section=${encodeURIComponent(sectionName)}`, { credentials: 'include' });
          const students = await res.json();
          attendanceTable.innerHTML = '';
          students.forEach(student => addStudentRow(student));
        } catch (err) {
          console.error(err);
        }
      }

      loadStudents();

      addBtn.addEventListener("click", async () => {
        const name = studentNameInput.value.trim();
        if (!name) return alert("Enter your name.");

        try {
          const res = await fetch('api/students.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ section: sectionName, name }),
            credentials: 'include'
          });
          const newStudent = await res.json();
          if (newStudent.error) return alert(newStudent.error);
          addStudentRow(newStudent);
          if (userRole === 'student') studentNameInput.value = userName; 
          else studentNameInput.value = '';
        } catch (err) {
          console.error(err);
        }
      });

      function addStudentRow(student) {
        const { id, name, image, status, added_at } = student;

        const row = document.createElement("tr");

        const timeCell = document.createElement("td");
        timeCell.textContent = added_at;

        const nameCell = document.createElement("td");
        nameCell.textContent = name;

        const pictureCell = document.createElement("td");
        const uploadBtn = document.createElement("button");
        uploadBtn.textContent = "Upload";
        uploadBtn.classList.add("upload-btn");

        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        fileInput.style.display = "none";

        const imagePreview = document.createElement("img");
        imagePreview.classList.add("upload-img");
        imagePreview.style.cursor = "pointer";
        if (image) {
          imagePreview.src = image;
          imagePreview.style.display = "block";
          uploadBtn.style.display = "none";
        }
        imagePreview.addEventListener('click', () => {
          if (imagePreview.src) {
            document.getElementById('modalImage').src = imagePreview.src;
            document.getElementById('imageModal').style.display = 'block';
          }
        });

        uploadBtn.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", async () => {
          const file = fileInput.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append('image', file);
          formData.append('student_id', id);

          try {
            const res = await fetch('api/upload.php', {
              method: 'POST',
              body: formData
            });
            const result = await res.json();
            if (result.error) return alert(result.error);

            imagePreview.src = result.url;
            imagePreview.style.display = "block";
            uploadBtn.style.display = "none";
            imagePreview.style.cursor = "pointer";
          } catch (err) {
            console.error(err);
          }
        });

        pictureCell.append(uploadBtn, fileInput, imagePreview);

        const statusCell = document.createElement("td");
        const presentBtn = document.createElement("button");
        presentBtn.textContent = "Present";
        presentBtn.classList.add("status-btn", "present");

        const absentBtn = document.createElement("button");
        absentBtn.textContent = "Absent";
        absentBtn.classList.add("status-btn", "absent");

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "âœ–";
        deleteBtn.classList.add("delete-btn");

        const statusCircle = document.createElement("div");
        statusCircle.classList.add("status-circle");
        if (status === "Present") statusCircle.style.background = "green";
        if (status === "Absent") statusCircle.style.background = "red";

        if (userRole === 'teacher') {
          presentBtn.addEventListener("click", () => updateStatus("Present"));
          absentBtn.addEventListener("click", () => updateStatus("Absent"));
          deleteBtn.addEventListener("click", async () => {
            if (!confirm(`Delete student "${name}"?`)) return;
            try {
              const res = await fetch('api/students.php', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_id: id }),
                credentials: 'include'
              });
              const result = await res.json();
              if (result.success) row.remove();
              else alert(result.error || 'Failed to delete student');
            } catch (err) {
              console.error(err);
            }
          });
        } else {
          presentBtn.disabled = true;
          absentBtn.disabled = true;
          presentBtn.style.opacity = 0.5;
          absentBtn.style.opacity = 0.5;
          deleteBtn.style.display = "none";
        }

        async function updateStatus(newStatus) {
          try {
            const res = await fetch('api/students.php', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ student_id: id, status: newStatus }),
              credentials: 'include'
            });
            const result = await res.json();
            if (result.success) statusCircle.style.background = newStatus === "Present" ? "green" : "red";
            else alert(result.error || 'Failed to update status');
          } catch (err) {
            console.error(err);
          }
        }

        statusCell.classList.add("status-cell");
        statusCell.append(presentBtn, absentBtn, statusCircle, deleteBtn);

        row.append(timeCell, nameCell, pictureCell, statusCell);
        attendanceTable.appendChild(row);
      }
    });
  </script>

</body>

</html>